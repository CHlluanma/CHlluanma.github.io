

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>docker-部署 - </title>

  <meta name="description" content="使用Docker 以及Docker Compose部署Go程序
为什么需要docker

使用docker的主要目标是其容器化。可以为应用程序提供一致的环境，而不依赖它运行的主机


部署示例
1.准备代码
package main

import (
        &#34;fmt&#34;
        &#34;net/http&#34;
)

func main() {
        http.HandleFunc(&#34;/&#34;, hello)
        server := &amp;http.Server{
                Addr: &#34;:8888&#34;,
        }
  fmt.Println(&#34;server startup...&#34;)
        if err := server.ListenAndServe(); err != nil {
                fmt.Printf(&#34;server startup failed, err:%v\n&#34;, err)
        }
}

func hello(w http.ResponseWriter, _ *http.Request) {
        w.Write([]byte(&#34;hello liwenzhou.com!&#34;))
}
这里是简单代码
2.创建Docker镜像

镜像(image)包含运行应用程序所需的所有东西——代码/二进制文件、运行时、依赖项以及所需的任何其它人间系统对象

简单讲，镜像是定义应用程序以及运行所需的一切
3.编写Dockerfile
要创建Docker镜像(image)必须在配置文件中的指定步骤，这个文件默认称为Dockerfile">
  <meta name="author" content="ch"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Beautiful Hugo",
    
    "url": "https:\/\/ahang7.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/ahang7.github.io\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/ahang7.github.io\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/ahang7.github.io\/post\/basic\/docker\/docker%E9%83%A8%E7%BD%B2\/",
          "name": "Docker 部署"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "ch"
  },
  "headline": "docker-部署",
  "description" : "使用Docker 以及Docker Compose部署Go程序\n为什么需要docker 使用docker的主要目标是其容器化。可以为应用程序提供一致的环境，而不依赖它运行的主机\n部署示例 1.准备代码 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net\/http\u0026#34; ) func main() { http.HandleFunc(\u0026#34;\/\u0026#34;, hello) server := \u0026amp;http.Server{ Addr: \u0026#34;:8888\u0026#34;, } fmt.Println(\u0026#34;server startup...\u0026#34;) if err := server.ListenAndServe(); err != nil { fmt.Printf(\u0026#34;server startup failed, err:%v\\n\u0026#34;, err) } } func hello(w http.ResponseWriter, _ *http.Request) { w.Write([]byte(\u0026#34;hello liwenzhou.com!\u0026#34;)) } 这里是简单代码\n2.创建Docker镜像 镜像(image)包含运行应用程序所需的所有东西——代码\/二进制文件、运行时、依赖项以及所需的任何其它人间系统对象\n简单讲，镜像是定义应用程序以及运行所需的一切\n3.编写Dockerfile 要创建Docker镜像(image)必须在配置文件中的指定步骤，这个文件默认称为Dockerfile\n",
  "inLanguage" : "en",
  "wordCount":  520 ,
  "datePublished" : "2024-09-28T00:00:00\u002b00:00",
  "dateModified" : "2024-09-28T00:00:00\u002b00:00",
  "image" : "https:\/\/ahang7.github.io\/img\/avatar-icon.png",
  "keywords" : [ "docker" ],
  "mainEntityOfPage" : "https:\/\/ahang7.github.io\/post\/basic\/docker\/docker%E9%83%A8%E7%BD%B2\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/ahang7.github.io\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/ahang7.github.io\/img\/avatar-icon.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>


<meta property="og:title" content="docker-部署" />
<meta property="og:description" content="使用Docker 以及Docker Compose部署Go程序
为什么需要docker

使用docker的主要目标是其容器化。可以为应用程序提供一致的环境，而不依赖它运行的主机


部署示例
1.准备代码
package main

import (
        &#34;fmt&#34;
        &#34;net/http&#34;
)

func main() {
        http.HandleFunc(&#34;/&#34;, hello)
        server := &amp;http.Server{
                Addr: &#34;:8888&#34;,
        }
  fmt.Println(&#34;server startup...&#34;)
        if err := server.ListenAndServe(); err != nil {
                fmt.Printf(&#34;server startup failed, err:%v\n&#34;, err)
        }
}

func hello(w http.ResponseWriter, _ *http.Request) {
        w.Write([]byte(&#34;hello liwenzhou.com!&#34;))
}
这里是简单代码
2.创建Docker镜像

镜像(image)包含运行应用程序所需的所有东西——代码/二进制文件、运行时、依赖项以及所需的任何其它人间系统对象

简单讲，镜像是定义应用程序以及运行所需的一切
3.编写Dockerfile
要创建Docker镜像(image)必须在配置文件中的指定步骤，这个文件默认称为Dockerfile">
<meta property="og:image" content="https://ahang7.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://ahang7.github.io/post/basic/docker/docker%E9%83%A8%E7%BD%B2/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Beautiful Hugo" />

  <meta name="twitter:title" content="docker-部署" />
  <meta name="twitter:description" content="使用Docker 以及Docker Compose部署Go程序
为什么需要docker

使用docker的主要目标是其容器化。可以为应用程序提供一致的环境，而不依赖它运行的主机


部署示例
1.准备代码
package main

import (
        &#34;fmt&#34;
        &#34;net/http&#34;
)

func main() { …">
  <meta name="twitter:image" content="https://ahang7.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://ahang7.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.136.0">
  <link rel="alternate" href="https://ahang7.github.io/index.xml" type="application/rss+xml" title="Beautiful Hugo"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://ahang7.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://ahang7.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://ahang7.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://ahang7.github.io/">Beautiful Hugo</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" role="button" tabindex="0">Samples</a>
              <div class="navlinks-children">
                
                  <a href="/post/2017-03-07-bigimg-sample">Big Image Sample</a>
                
                  <a href="/post/2017-03-05-math-sample">Math Sample</a>
                
                  <a href="/post/2016-03-08-code-sample">Code Sample</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Beautiful Hugo" href="https://ahang7.github.io/">
            <img class="avatar-img" src="https://ahang7.github.io/img/avatar-icon.png" alt="Beautiful Hugo" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>docker-部署</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on September 28, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;3&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;520&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ch
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>使用Docker 以及Docker Compose部署Go程序</p>
<h2 id="为什么需要docker">为什么需要docker</h2>
<blockquote>
<p>使用docker的主要目标是其容器化。可以为应用程序提供一致的环境，而不依赖它运行的主机</p>
</blockquote>
<hr>
<h3 id="部署示例">部署示例</h3>
<h4 id="1准备代码">1.准备代码</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">package main
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import (
</span></span><span class="line"><span class="cl">        &#34;fmt&#34;
</span></span><span class="line"><span class="cl">        &#34;net/http&#34;
</span></span><span class="line"><span class="cl">)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func main() {
</span></span><span class="line"><span class="cl">        http.HandleFunc(&#34;/&#34;, hello)
</span></span><span class="line"><span class="cl">        server := &amp;http.Server{
</span></span><span class="line"><span class="cl">                Addr: &#34;:8888&#34;,
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">  fmt.Println(&#34;server startup...&#34;)
</span></span><span class="line"><span class="cl">        if err := server.ListenAndServe(); err != nil {
</span></span><span class="line"><span class="cl">                fmt.Printf(&#34;server startup failed, err:%v\n&#34;, err)
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">func hello(w http.ResponseWriter, _ *http.Request) {
</span></span><span class="line"><span class="cl">        w.Write([]byte(&#34;hello liwenzhou.com!&#34;))
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>这里是简单代码</p>
<h4 id="2创建docker镜像">2.创建Docker镜像</h4>
<blockquote>
<p>镜像(image)包含运行应用程序所需的所有东西——代码/二进制文件、运行时、依赖项以及所需的任何其它人间系统对象</p>
</blockquote>
<p>简单讲，镜像是定义应用程序以及运行所需的一切</p>
<h4 id="3编写dockerfile">3.编写Dockerfile</h4>
<p>要创建Docker镜像(image)必须在配置文件中的指定步骤，这个文件默认称为<code>Dockerfile</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">FROM golang:alpine
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 为我们的镜像设置必要的环境变量
</span></span><span class="line"><span class="cl">ENV GO111MODULE=on \
</span></span><span class="line"><span class="cl">    CGO_ENABLED=0 \
</span></span><span class="line"><span class="cl">    GOOS=linux \
</span></span><span class="line"><span class="cl">    GOARCH=amd64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 移动到工作目录：/build
</span></span><span class="line"><span class="cl">WORKDIR /build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将代码复制到容器中
</span></span><span class="line"><span class="cl">COPY . .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将我们的代码编译成二进制可执行文件app
</span></span><span class="line"><span class="cl">RUN go build -o app .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 移动到用于存放生成的二进制文件的 /dist 目录
</span></span><span class="line"><span class="cl">WORKDIR /dist
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将二进制文件从 /build 目录复制到这里
</span></span><span class="line"><span class="cl">RUN cp /build/app .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 声明服务端口
</span></span><span class="line"><span class="cl">EXPOSE 8888
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 启动容器时运行的命令
</span></span><span class="line"><span class="cl">CMD [&#34;/dist/app&#34;]
</span></span></code></pre></div><h4 id="4dockerfile解析">4.Dockerfile解析</h4>
<ul>
<li><strong>From</strong></li>
</ul>
<p>使用了基础镜像 <code>golang:alpine</code>来创建镜像。这个镜像运行的是alpine Linux发行版，该发行版的大小很小并内置了Go。有大量公开可用的Docker镜像，请查看https://hub.docker.com/_/golang</p>
<ul>
<li>Env</li>
</ul>
<p>用来设置编译阶段需要的环境变量</p>
<ul>
<li>
<p>WORKDIR,COPY,RUN</p>
</li>
<li>
<p>EXPORT,CMD</p>
</li>
</ul>
<p>声明服务端口，应用程序监听这个端口并通过这个端口对外提供服务。还定义了运行镜像执行的默认执行命令<code>CMD [&quot;/dist/app&quot;]</code></p>
<hr>
<h3 id="构建镜像">构建镜像</h3>
<p>在项目目录下面，在终端输入下面的命令创建镜像，并指定镜像名称为<code>go_app</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">docker build . -t go_app
</span></span></code></pre></div><p>等待构建结束，输出 <code>Successfully</code></p>
<p>等输出 <code>Successfully</code>后，此时镜像已经准备好了，但是目前什么项目都没有，需要运行下面的代码来运行镜像。注：<strong>运行中的镜像称为镜像</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">docker run -p 8888:8888 go_app
</span></span></code></pre></div><p>标志位<code>-p</code>来定义端口绑定，由于容器中的应用程序在端口8888上运行，这里绑定的主机端口也是8888。如果要绑定另一个端口，则可以使用 <code>-p $HOST_PORT:8888</code></p>
<p>到这里就可以测试我们的程序是否工作正常，打开 http://127.0.0.1:8888 查看事先定义的响应内容。</p>
<hr>
<h3 id="分阶段构建示例">分阶段构建示例</h3>
<p>Go程序编译之后可得到一个可执行的二进制文件，在最终的镜像中不需要go编译器，也就是说我们只需要一个运行最终二进制文件的容器即可。</p>
<p>Docker的最佳实践之一是通过仅保留二进制文件来减小镜像大小，为此，我们将使用一种称为多阶段构建的技术</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">FROM golang:alpine AS builder
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 为我们的镜像设置必要的环境变量
</span></span><span class="line"><span class="cl">ENV GO111MODULE=on \
</span></span><span class="line"><span class="cl">    CGO_ENABLED=0 \
</span></span><span class="line"><span class="cl">    GOOS=linux \
</span></span><span class="line"><span class="cl">    GOARCH=amd64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 移动到工作目录：/build
</span></span><span class="line"><span class="cl">WORKDIR /build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将代码复制到容器中
</span></span><span class="line"><span class="cl">COPY . .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将我们的代码编译成二进制可执行文件 app
</span></span><span class="line"><span class="cl">RUN go build -o app .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">###################
</span></span><span class="line"><span class="cl"># 接下来创建一个小镜像
</span></span><span class="line"><span class="cl">###################
</span></span><span class="line"><span class="cl">FROM scratch
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 从builder镜像中把/dist/app 拷贝到当前目录
</span></span><span class="line"><span class="cl">COPY --from=builder /build/app /
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 需要运行的命令
</span></span><span class="line"><span class="cl">ENTRYPOINT [&#34;/app&#34;]
</span></span></code></pre></div><p>使用这种技术，我们剥离了使用<code>golang:alpine</code>作为编译镜像来编译得到二进制可执行文件的过程，并基于<code>scratch</code>生成一个简单的、非常小的新镜像。我们将二进制文件从命名为<code>builder</code>的第一个镜像中复制到新创建的<code>scratch</code>镜像中。有关scratch镜像的更多信息，请查看https://hub.docker.com/_/scratch</p>
<hr>
<h3 id="附带其他文件的部署示例">附带其他文件的部署示例</h3>
<p>web项目(前后端不分离)一般会有静态文件或者配置文件，需要拷贝到最终的镜像文件中</p>
<p>例如 <code>templates</code> | <code>static</code> | <code>conf</code> 三个文件的内容拷贝到镜像文件中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">FROM golang:alpine AS builder
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 为我们的镜像设置必要的环境变量
</span></span><span class="line"><span class="cl">ENV GO111MODULE=on \
</span></span><span class="line"><span class="cl">    CGO_ENABLED=0 \
</span></span><span class="line"><span class="cl">    GOOS=linux \
</span></span><span class="line"><span class="cl">    GOARCH=amd64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 移动到工作目录：/build
</span></span><span class="line"><span class="cl">WORKDIR /build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 复制项目中的 go.mod 和 go.sum文件并下载依赖信息
</span></span><span class="line"><span class="cl">COPY go.mod .
</span></span><span class="line"><span class="cl">COPY go.sum .
</span></span><span class="line"><span class="cl">RUN go mod download
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将代码复制到容器中
</span></span><span class="line"><span class="cl">COPY . .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将我们的代码编译成二进制可执行文件 bubble
</span></span><span class="line"><span class="cl">RUN go build -o bubble .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">###################
</span></span><span class="line"><span class="cl"># 接下来创建一个小镜像
</span></span><span class="line"><span class="cl">###################
</span></span><span class="line"><span class="cl">FROM scratch
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COPY ./templates /templates
</span></span><span class="line"><span class="cl">COPY ./static /static
</span></span><span class="line"><span class="cl">COPY ./conf /conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 从builder镜像中把/dist/app 拷贝到当前目录
</span></span><span class="line"><span class="cl">COPY --from=builder /build/bubble /
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 需要运行的命令
</span></span><span class="line"><span class="cl">ENTRYPOINT [&#34;/bubble&#34;, &#34;conf/config.ini&#34;]
</span></span></code></pre></div><p><strong>Tips：</strong> 这里把COPY静态文件的步骤放在上层，把COPY二进制可执行文件放在下层，争取多使用缓存。</p>
<hr>
<h3 id="关联其他容器">关联其他容器</h3>
<p>项目中使用了MySQL，可以选择使用如下命令启动一个MySQL容器，它的别名为<code>mysql8019</code>；root用户的密码为<code>root1234</code>；挂载容器中的<code>/var/lib/mysql</code>到本地的<code>/Users/docker/mysql</code>目录；内部服务端口为3306，映射到外部的13306端口。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">docker run --name mysql8019 -p 13306:3306 -e MYSQL_ROOT_PASSWORD=root1234 -v /Users/q1mi/docker/mysql:/var/lib/mysql -d mysql:8.0.19
</span></span></code></pre></div><p>这里需要修改一下我们程序中配置的MySQL的host地址为容器别名，使它们在内部通过别名（此处为mysql8019）联通。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">[mysql]
</span></span><span class="line"><span class="cl">user = root
</span></span><span class="line"><span class="cl">password = root1234
</span></span><span class="line"><span class="cl">host = mysql8019
</span></span><span class="line"><span class="cl">port = 3306
</span></span><span class="line"><span class="cl">db = bubble
</span></span></code></pre></div><p>修改后记得重新构建<code>bubble_app</code>镜像：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">docker build . -t bubble_app
</span></span></code></pre></div><p>我们这里运行<code>bubble_app</code>容器的时候需要使用<code>--link</code>的方式与上面的<code>mysql8019</code>容器关联起来，具体命令如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">docker run --link<span class="o">=</span>mysql8019:mysql8019 -p 8888:8888 bubble_app
</span></span></code></pre></div><hr>
<h3 id="docker-compose模式">Docker Compose模式</h3>
<p>除了像上面一样使用<code>--link</code>的方式来关联两个容器之外，我们还可以使用<code>Docker Compose</code>来定义和运行多个容器。</p>
<p><code>Compose</code>是用于定义和运行多容器 Docker 应用程序的工具。通过 Compose，你可以使用 YML 文件来配置应用程序需要的所有服务。然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。</p>
<p>使用Compose基本上是一个三步过程：</p>
<ol>
<li>
<p>使用<code>Dockerfile</code>定义你的应用环境以便可以在任何地方复制。</p>
</li>
<li>
<p>定义组成应用程序的服务，<code>docker-compose.yml</code> 以便它们可以在隔离的环境中一起运行。</p>
</li>
<li>
<p>执行 <code>docker-compose up</code>命令来启动并运行整个应用程序。</p>
</li>
</ol>
<p>我们的项目需要两个容器分别运行<code>mysql</code>和<code>bubble_app</code>，我们编写的<code>docker-compose.yml</code>文件内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl"># yaml 配置
</span></span><span class="line"><span class="cl">version: &#34;3.7&#34;
</span></span><span class="line"><span class="cl">services:
</span></span><span class="line"><span class="cl">  mysql8019:
</span></span><span class="line"><span class="cl">    image: &#34;mysql:8.0.19&#34;
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">      - &#34;33061:3306&#34;
</span></span><span class="line"><span class="cl">    command: &#34;--default-authentication-plugin=mysql_native_password --init-file /data/application/init.sql&#34;
</span></span><span class="line"><span class="cl">    environment:
</span></span><span class="line"><span class="cl">      MYSQL_ROOT_PASSWORD: &#34;root1234&#34;
</span></span><span class="line"><span class="cl">      MYSQL_DATABASE: &#34;bubble&#34;
</span></span><span class="line"><span class="cl">      MYSQL_PASSWORD: &#34;root1234&#34;
</span></span><span class="line"><span class="cl">    volumes:
</span></span><span class="line"><span class="cl">      - ./init.sql:/data/application/init.sql
</span></span><span class="line"><span class="cl">  bubble_app:
</span></span><span class="line"><span class="cl">    build: .
</span></span><span class="line"><span class="cl">    command: sh -c &#34;./wait-for.sh mysql8019:3306 -- ./bubble ./conf/config.ini&#34;
</span></span><span class="line"><span class="cl">    depends_on:
</span></span><span class="line"><span class="cl">      - mysql8019
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">      - &#34;8888:8888&#34;
</span></span></code></pre></div><p>这个 Compose 文件定义了两个服务：<code>bubble_app</code> 和 <code>mysql8019</code>。其中：</p>
<h5 id="bubble_app">bubble_app</h5>
<p>使用当前目录下的<code>Dockerfile</code>文件构建镜像，并通过<code>depends_on</code>指定依赖<code>mysql8019</code>服务，声明服务端口8888并绑定对外8888端口。</p>
<h5 id="mysql8019">mysql8019</h5>
<p>mysql8019 服务使用 Docker Hub 的公共 mysql:8.0.19 镜像，内部端口3306，外部端口33061。</p>
<p>这里需要注意一个问题就是，我们的<code>bubble_app</code>容器需要等待<code>mysql8019</code>容器正常启动之后再尝试启动，因为我们的web程序在启动的时候会初始化MySQL连接。这里共有两个地方要更改，第一个就是我们<code>Dockerfile</code>中要把最后一句注释掉：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl"># Dockerfile
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"># 需要运行的命令（注释掉这一句，因为需要等MySQL启动之后再启动我们的Web程序）
</span></span><span class="line"><span class="cl"># ENTRYPOINT [&#34;/bubble&#34;, &#34;conf/config.ini&#34;]
</span></span></code></pre></div><p>第二个地方是在<code>bubble_app</code>下面添加如下命令，使用提前编写的<code>wait-for.sh</code>脚本检测<code>mysql8019:3306</code>正常后再执行后续启动Web应用程序的命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">command: sh -c &#34;./wait-for.sh mysql8019:3306 -- ./bubble ./conf/config.ini&#34;
</span></span></code></pre></div><p>当然，因为我们现在要在<code>bubble_app</code>镜像中执行sh命令，所以不能在使用<code>scratch</code>镜像构建了，这里改为使用<code>debian:stretch-slim</code>，同时还要安装<code>wait-for.sh</code>脚本用到的<code>netcat</code>，最后不要忘了把<code>wait-for.sh</code>脚本文件COPY到最终的镜像中，并赋予可执行权限哦。更新后的<code>Dockerfile</code>内容如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plaintext" data-lang="Plaintext"><span class="line"><span class="cl">FROM golang:alpine AS builder
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 为我们的镜像设置必要的环境变量
</span></span><span class="line"><span class="cl">ENV GO111MODULE=on \
</span></span><span class="line"><span class="cl">    CGO_ENABLED=0 \
</span></span><span class="line"><span class="cl">    GOOS=linux \
</span></span><span class="line"><span class="cl">    GOARCH=amd64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 移动到工作目录：/build
</span></span><span class="line"><span class="cl">WORKDIR /build
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 复制项目中的 go.mod 和 go.sum文件并下载依赖信息
</span></span><span class="line"><span class="cl">COPY go.mod .
</span></span><span class="line"><span class="cl">COPY go.sum .
</span></span><span class="line"><span class="cl">RUN go mod download
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将代码复制到容器中
</span></span><span class="line"><span class="cl">COPY . .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 将我们的代码编译成二进制可执行文件 bubble
</span></span><span class="line"><span class="cl">RUN go build -o bubble .
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">###################
</span></span><span class="line"><span class="cl"># 接下来创建一个小镜像
</span></span><span class="line"><span class="cl">###################
</span></span><span class="line"><span class="cl">FROM debian:stretch-slim
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COPY ./wait-for.sh /
</span></span><span class="line"><span class="cl">COPY ./templates /templates
</span></span><span class="line"><span class="cl">COPY ./static /static
</span></span><span class="line"><span class="cl">COPY ./conf /conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 从builder镜像中把/dist/app 拷贝到当前目录
</span></span><span class="line"><span class="cl">COPY --from=builder /build/bubble /
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">RUN set -eux; \
</span></span><span class="line"><span class="cl">        apt-get update; \
</span></span><span class="line"><span class="cl">        apt-get install -y \
</span></span><span class="line"><span class="cl">                --no-install-recommends \
</span></span><span class="line"><span class="cl">                netcat; \
</span></span><span class="line"><span class="cl">        chmod 755 wait-for.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 需要运行的命令
</span></span><span class="line"><span class="cl"># ENTRYPOINT [&#34;/bubble&#34;, &#34;conf/config.ini&#34;]
</span></span></code></pre></div><p>所有的条件都准备就绪后，就可以执行下面的命令跑起来了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Bash" data-lang="Bash"><span class="line"><span class="cl">docker-compose up
</span></span></code></pre></div>

        
          <div class="blog-tags">
            
              
              <a href="https://ahang7.github.io/tags/docker/">docker</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fahang7.github.io%2fpost%2fbasic%2fdocker%2fdocker%25E9%2583%25A8%25E7%25BD%25B2%2f&amp;text=docker-%e9%83%a8%e7%bd%b2&amp;via=" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fahang7.github.io%2fpost%2fbasic%2fdocker%2fdocker%25E9%2583%25A8%25E7%25BD%25B2%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fahang7.github.io%2fpost%2fbasic%2fdocker%2fdocker%25E9%2583%25A8%25E7%25BD%25B2%2f&amp;title=docker-%e9%83%a8%e7%bd%b2" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fahang7.github.io%2fpost%2fbasic%2fdocker%2fdocker%25E9%2583%25A8%25E7%25BD%25B2%2f&amp;title=docker-%e9%83%a8%e7%bd%b2" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fahang7.github.io%2fpost%2fbasic%2fdocker%2fdocker%25E9%2583%25A8%25E7%25BD%25B2%2f&amp;title=docker-%e9%83%a8%e7%bd%b2" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fahang7.github.io%2fpost%2fbasic%2fdocker%2fdocker%25E9%2583%25A8%25E7%25BD%25B2%2f&amp;description=docker-%e9%83%a8%e7%bd%b2" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/post/basic/docker/docker/">docker-基础</a></li>
                
                    <li><a href="/post/basic/docker/dockerfile%E5%AD%A6%E4%B9%A0/">dockerfile-学习</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://ahang7.github.io/post/basic/docker/dockerfile%E5%AD%A6%E4%B9%A0/" data-toggle="tooltip" data-placement="top" title="dockerfile-学习">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://ahang7.github.io/post/basic/docker/docker/" data-toggle="tooltip" data-placement="top" title="docker-基础">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
      
      
      
      
        
      

    </div>
  </div>
</div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="mailto:ch1447571882@qq.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://github.com/ahang7" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://gitlab.com/username" title="GitLab">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-gitlab fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="yourwebsite.com">ch</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://ahang7.github.io/">Beautiful Hugo</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.136.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://ahang7.github.io/js/main.js"></script>
<script src="https://ahang7.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://ahang7.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

