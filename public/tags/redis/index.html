

<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

 


      <title>Redis - </title>

  <meta name="author" content="ch"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Beautiful Hugo",
    
    "url": "https:\/\/ahang7.github.io\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/ahang7.github.io\/"
  
  
  
  
}
</script>

<meta property="og:title" content="Redis" />
<meta property="og:image" content="https://ahang7.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://ahang7.github.io/tags/redis/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Beautiful Hugo" />

  <meta name="twitter:title" content="Redis" />
  <meta name="twitter:image" content="https://ahang7.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://ahang7.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.136.0">
  <link rel="alternate" href="https://ahang7.github.io/index.xml" type="application/rss+xml" title="Beautiful Hugo"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css" integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous"><link rel="stylesheet" href="https://ahang7.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://ahang7.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://ahang7.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://ahang7.github.io/">Beautiful Hugo</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" role="button" tabindex="0">Samples</a>
              <div class="navlinks-children">
                
                  <a href="/post/2017-03-07-bigimg-sample">Big Image Sample</a>
                
                  <a href="/post/2017-03-05-math-sample">Math Sample</a>
                
                  <a href="/post/2016-03-08-code-sample">Code Sample</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Beautiful Hugo" href="https://ahang7.github.io/">
            <img class="avatar-img" src="https://ahang7.github.io/img/avatar-icon.png" alt="Beautiful Hugo" />
           
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="tags-heading">
              
                <h1>Redis</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
  <div class="container" role="main">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
        <div class="posts-list">
          
            <article class="post-preview">
    <a href="https://ahang7.github.io/post/basic/redis/6-redis%E9%9B%86%E7%BE%A4/">
        <h2 class="post-title">[redis] 集群</h2>
        
        <h3 class="post-subtitle">
            nil
        </h3>
        
        
        
    </a>

    <p class="post-meta">
        <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 30, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;0&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;0&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ch
    
  
  
</span>


    </p>
    <div class="post-entry">
        
        
        
    </div>

    
    <div class="blog-tags">
        
       
       <a href="https://ahang7.github.io/tags/redis/">redis</a>&nbsp;
         
    </div>
    

</article>
          
            <article class="post-preview">
    <a href="https://ahang7.github.io/post/basic/redis/5-redis%E5%9C%BA%E6%99%AF/">
        <h2 class="post-title">[redis] 场景</h2>
        
        <h3 class="post-subtitle">
            redis的使用场景——缓存和分布式锁
        </h3>
        
        
        
    </a>

    <p class="post-meta">
        <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 29, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;172&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ch
    
  
  
</span>


    </p>
    <div class="post-entry">
        
        <h2 id="六场景">六、场景</h2>
<h3 id="1缓存">1.缓存</h3>
<p>Redis由于性能高效，通常可以做数据库存储的缓存，比如给Mysql做缓存</p>
<p>通常业务都满足二八原则，80%的流量在20%的热点数据上，所以缓存可以很大程度提高系统的吞吐量</p>
<h4 id="11缓存基础">1.1缓存基础</h4>
<p>一般而言，缓存分为服务器缓存，客户端缓存</p>
<p>缓存一般有以下几种模式：</p>
<ol>
<li>
<p>旁路缓存模式：</p>
</li>
<li>
<p>读穿透模式：</p>
</li>
<li>
<p>写穿透模式：</p>
</li>
<li>
<p>异步缓存写入模式：</p>
</li>
</ol>
<h5 id="旁路缓存模式适用于读多写少">旁路缓存模式（适用于读多写少）</h5>
<p>Cache Aside，旁路缓存模式，是<strong>最常见的模式</strong>，应用服务把缓存当作数据库的旁路，直接和缓存交互</p>
<ul>
<li>
<p>读操作：服务端收到查询请求，先查询数据是否在缓存上，如果在，就用缓存数据直接打包返回，如果不存在，就去数据库查询，并放到缓存</p>
</li>
<li>
<p>写操作：cache aside模式一般先更新数据库，再直接删除缓存（更新相比删除更容易造成时序性问题）</p>
</li>
</ul>
<p>适用于读多写少的场景，缺点是可能会出现缓存和数据库不一致的情况</p>
<blockquote>
<p>这里的写操作，更新相比删除更容易造成时序性问题，具体举例：线程1更新mysql -&gt; 线程2更新mysql -&gt; 线程2更新缓存 -&gt; 线程1更新mysql，这样就出现了时许性问题</p>
</blockquote>
<p>该模型的缺点：</p>
<p>可能出现缓存和数据库不一致的情况，具体见：<a href="https://xiaolincoding.com/redis/architecture/mysql_redis_consistency.html#%E5%85%88%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93-%E8%BF%98%E6%98%AF%E5%85%88%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98">数据库和缓存如何保证一致性？</a></p>
<h5 id="读穿透模式">读穿透模式</h5>
<p>与cache aside模式的区别主要在应用服务不再与缓存直接交互，而是直接去访问数据服务。</p>
<p>这里的数据服务理解为一个**代理服务，**用它来访问缓存和数据库</p>
<p><img src="https://rt5bap83jl.feishu.cn/space/api/box/stream/download/asynccode/?code=NGRhNWI5ZGY3OGFiNjlkNTc3NTQ1MTdjMGJiOTg2YmJfT09iTTdsU1pjbnNsR0dlU2ZvMEprMGlDa1hjd0l1QldfVG9rZW46TmE5MGJGTW52b3RWbHN4SmZadmM2dXZTbjJnXzE3MjE4NDE0OTU6MTcyMTg0NTA5NV9WNA" alt=""></p>
<p>相比于旁路缓存模式，读穿透模式的优势是缓存对业务是透明的；缺点是缓存命中的性能不如旁路缓存模式，会多一层服务调用</p>
<h5 id="写穿透模式">写穿透模式</h5>
<p>WriteThrough做了一层封装：有缓存服务先写入Mysql，再同步写入Redis，这样及时加载或更新了缓存数据（理解为，应用程序由一个单独的访问源，而存储服务自己维护访问逻辑）</p>
<p><img src="https://rt5bap83jl.feishu.cn/space/api/box/stream/download/asynccode/?code=YWE5MTA1Y2MyNWE3OTYyY2I3Y2FmZjNiM2VmN2M3NDBfV1JIVlJVR01KN3VCakM4WVZ2REpFeXRtb21nb1ZYa0FfVG9rZW46U0F6emJXa3JFb29tSHV4OWh6cmNFdGpVbnllXzE3MjE4NDE0OTU6MTcyMTg0NTA5NV9WNA" alt=""></p>
<p>在使用WriteThrough时，一般都配合使用ReadThrough来使用</p>
<p>适用情况：</p>
<ul>
<li>
<p>对缓存及时性要求更高</p>
</li>
<li>
<p>不能忍受数据丢失和数据不一致</p>
</li>
</ul>
<h5 id="异步缓存写入模式write-behind">异步缓存写入模式（Write-Behind）</h5>
<p>write-Behind和Write-Through相同点是都是写入时会更新数据库、也会更新缓存</p>
<p>不同点是：Write-Behind是先写缓存，后<strong>异步</strong>把数据一起写入数据库</p>
<p>数据库写操作可以用不同的方式完成：</p>
<ol>
<li>
<p>收集写操作并在某个时间点慢慢写入</p>
</li>
<li>
<p>合并几个写操作成为一个批量操作，一起批量写入</p>
</li>
</ol>
<p>异步写操作极大降低了请求延迟，并减轻了数据库的负担，但是代价是安全性不够，如果缓存中的数据还没写入数据库，存储服务发生了崩溃，那么数据就丢失了</p>
<h4 id="12缓存异常">1.2缓存异常</h4>
<h5 id="缓存穿透">缓存穿透</h5>
<ul>
<li>问题背景</li>
</ul>
<p>缓存穿透是指**缓存和数据库都没有的数据，**而用户不断发起请求。</p>
<p>在流量大的时候，DB可能就挂掉了，要是有人利用不存在的key频繁攻击我们的应用，这就是漏洞</p>
<ul>
<li>解决方案</li>
</ul>
<ol>
<li>
<p>接口层增加校验，如用户鉴权校验，id做击穿校验，id&lt;=0的直接拦截</p>
</li>
<li>
<p>从缓存取不到的数据，在数据库中也没有取到，这时可以将key-value对写成key-null，缓存有效时间写短点，例如30s</p>
</li>
<li>
<p>布隆过滤器：bloomfilter类似于一个hash set，用于快速判断某个元素是否存在于集合中，关键在于hash算法和容器大小</p>
</li>
</ol>
<blockquote>
<p>布隆过滤器：</p>
<p>原理：布隆过滤器底层是一个64位的整型，将字符串用多个Hash函数映射不同的二进制位置，将整型中对应位置设置为1</p>
<p>优点：空间、时间消耗都很小</p>
<p>缺点：结果不完全准</p>
</blockquote>
<h5 id="缓存击穿">缓存击穿</h5>
<ul>
<li>问题背景</li>
</ul>
<p>缓存击穿是指<strong>缓存中没有但数据库中有的数据</strong>（一般缓存时间到期），这时由于并发的用户过多，同时读缓存没有数据又同时查询数据库，引起数据库压力瞬时增大</p>
<ul>
<li>解决方案</li>
</ul>
<ol>
<li>
<p>热点数据支付续期，持续访问的数据不断续期，避免因为过期失效而被击穿</p>
</li>
<li>
<p>发现缓存失效，重建缓存加互斥锁，当线程查询缓存发现缓存不存在就会尝试加锁，线程抢锁，拿到锁的线程进行查询数据库，然后重建缓存</p>
</li>
</ol>
<h5 id="缓存雪崩">缓存雪崩</h5>
<ul>
<li>问题背景</li>
</ul>
<p>指大量的应用请求因为异常无法在Redis缓存中处理，直接打到数据库。这里的异常就是：<strong>缓存中数据<strong><strong>大批量</strong></strong>到过期时间，而查询数据量巨大，引起数据库压力过大甚者宕机</strong></p>
        <a href="https://ahang7.github.io/post/basic/redis/5-redis%E5%9C%BA%E6%99%AF/" class="post-read-more">[Read More]</a>
        
    </div>

    
    <div class="blog-tags">
        
       
       <a href="https://ahang7.github.io/tags/redis/">redis</a>&nbsp;
         
    </div>
    

</article>
          
            <article class="post-preview">
    <a href="https://ahang7.github.io/post/basic/redis/4-redis%E6%8C%81%E4%B9%85%E5%8C%96/">
        <h2 class="post-title">[redis] 持久化</h2>
        
        <h3 class="post-subtitle">
            redis的持久化策略 `RDB`&amp;&amp;`AOF`
        </h3>
        
        
        
    </a>

    <p class="post-meta">
        <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 28, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;183&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ch
    
  
  
</span>


    </p>
    <div class="post-entry">
        
        <h2 id="五持久化">五、持久化</h2>
<h3 id="0持久化介绍">0.持久化介绍</h3>
<p>redis是跑在内存里的，当程序重启或者服务崩溃，数据就会丢失，所以需要持久化，即把数据保存到可永久保存的存储设备中</p>
<h4 id="持久化方法">持久化方法</h4>
<p>redis提供两种方式来持久化：</p>
<h5 id="1rdbredis-database">1.RDB(Redis Database)</h5>
<p>记录Redis某个时刻的全部数据，这个方法的本质就是数据快照，直接保存二进制数据到磁盘，后续通过加载RDB文件恢复数据</p>
<p><img src="https://rt5bap83jl.feishu.cn/space/api/box/stream/download/asynccode/?code=Zjc1YTM5MmU0NGI0MTVmNDVmYjMxZGU1ODg3ZTNiMDZfM01CeE9kMU9iRlVlSTNyUTBRSHFVa0dNS3RwUEJ2MHRfVG9rZW46RGR5NGIxdFJrb0NPa1l4RzJ2OWNsUHNsbnRjXzE3MjE4NDE0NjM6MTcyMTg0NTA2M19WNA" alt=""></p>
<h5 id="2aofappend-only-file">2.AOF(Append Only File)</h5>
<p>记录执行的每条命令，重启之后通过重放命令来恢复数据，AOF是记录操作日志，后续通过日志重放恢复数据</p>
<h5 id="两种持久化方法的对比">两种持久化方法的对比（*）</h5>
<p>上面两种持久化方法对比：RDB（快照恢复）和AOF（日志恢复）</p>
<ol>
<li>
<p>体积方面：相同数据量下，RDB体积小，因为RDB记录的是二进制紧凑型数据</p>
</li>
<li>
<p>恢复速度方面：RDB是数据快照，可以直接加载，而AOF文件恢复，相当于重放情况，RDB显然更快</p>
</li>
<li>
<p>数据完整性：AOF记录了每条日志，RDB是间隔一段时间记录一次，用AOF恢复数据通常会更加完整</p>
</li>
</ol>
<h4 id="rdb好还是aof好">RDB好还是AOF好</h4>
<ul>
<li>
<p>业务本身需要的是缓存数据并且不是一个海量访问，可以不用开持久化</p>
</li>
<li>
<p>对数据本身十分重视，可以同时开启RDB和AOF，注意，在同时开启的情况下，只会用AOF来加载，如果只有RDB文件而没有AOF文件，不会用RDB文件去恢复数据，如果逻辑是你自主开启选择AOF，表明要强一点的一致性，但是AOF文件缺失，此时不会去使用RDB，业务RDB会少很多数据，此时启动是一个空库</p>
</li>
</ul>
<h3 id="1rdb">1.RDB</h3>
<p>RDB文件的内容是**二进制数据，**记录的是某一瞬间的内存数据，是实际的数据，也叫做快照</p>
<p>在Redis恢复数据时，RDB恢复数据的效率会比AOF高，因为会直接读取RDB文件到内存即可，不需要像AOF那样还需要额外执行操作命令的步骤才能恢复数据</p>
<h4 id="11-rdb怎么使用">1.1 RDB怎么使用</h4>
<p>Redis提供两个命令来使用RDB文件，分别是<code>save</code> 和<code>bgsave</code></p>
<ul>
<li>
<p><code>save</code> :执行了save命令，会在主线程生成RDB文件，由于和执行操作命令在同一个线程，所以写入RDB文件的时间太长，会<strong>阻塞主线程</strong></p>
</li>
<li>
<p><code>bgsave</code> :执行了bgsave命令，会创建一个子进程来生成RDB文件，这样可以<strong>避免主线程的阻塞</strong></p>
</li>
</ul>
<p>RDB文件的加载工作是在服务器启动时自动执行，Redis并没有提供专门加载RDB文件的命令</p>
<p>在Redis的配置文件中，有以下的选项来实现每隔一段时间自动执行一次bgsave命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Plain" data-lang="Plain"><span class="line"><span class="cl"># 这里写的是save，实际上是bgsave
</span></span><span class="line"><span class="cl">save 900 1         # 900s之内，对数据库进行至少1次修改
</span></span><span class="line"><span class="cl">save 300 10        # 300s之内，对数据库进行至少10次修改
</span></span><span class="line"><span class="cl">save 60 10000      # 60s之内，对数据库进行至少10000次修改
</span></span></code></pre></div><p>Redis的快照是<strong>全量快照</strong>，也就是说每次执行快照，都是把内存中的所有数据记录到磁盘中</p>
<blockquote>
<p>RDB快照的缺点：当服务器发送故障时，丢失的数据会比AOF更多</p>
</blockquote>
<h4 id="12-执行快照时bgsave修改数据会发生什么">1.2 执行快照时（bgsave），修改数据会发生什么？</h4>
<p>在执行bgsave时，主线程是可以继续执行操作命令，由子线程来构建RDB文件，所以内存里的数据是可以修改的</p>
<p>实现这一功能靠的是<strong>写时复制****技术</strong></p>
<p>流程如下：</p>
<ol>
<li>执行bgsave命令时，会fork()创建子进程，此时子进程和父进程是共享同一片内存数据</li>
</ol>
<p>主进程创建子进程时，子进程会复制父进程的页表，但是页表指向的物理内存跟主进程是同一个物理内存</p>
<ol start="2">
<li>此时如果主线程由写命令的执行，就会发生写时复制，物理内存才会被复制一次</li>
</ol>
<p><strong>发生<strong><strong>写时复制</strong></strong>后，<strong><strong>RDB</strong></strong>快照保存的是原本的<strong><strong>内存</strong></strong>数据</strong></p>
<p>这是因为创建bgsave子进程后，由于父子进程共享所有内存数据，所以可以直接将数据写入到RDB文件</p>
<ul>
<li>
<p>当主进程对共享的内存数据是<strong>只读****操作</strong>，那么主进程和bgsave子进程是相互不影响</p>
</li>
<li>
<p>当主进程对共享的内存数据进行<strong>写操作</strong>时，就会发生<strong>写时复制</strong>，这块数据的物理内存就会被复制一份，然后主线程在这个<strong>数据副本进行写操作</strong>，此时bgsave子进程继续把原来的数据（原物理内存）写入到RDB文件</p>
</li>
</ul>
<blockquote>
<p>执行bgsave时，在极端情况下，如果所有的共享内存都被修改，则此时的内存占用是原先的两倍</p>
</blockquote>
<h4 id="13-什么时候执行rdb持久化">1.3 什么时候执行RDB持久化</h4>
<ol>
<li>
<p>主动执行命令save</p>
</li>
<li>
<p>主动执行命令bgsave</p>
        <a href="https://ahang7.github.io/post/basic/redis/4-redis%E6%8C%81%E4%B9%85%E5%8C%96/" class="post-read-more">[Read More]</a>
        
    </div>

    
    <div class="blog-tags">
        
       
       <a href="https://ahang7.github.io/tags/redis/">redis</a>&nbsp;
         
    </div>
    

</article>
          
            <article class="post-preview">
    <a href="https://ahang7.github.io/post/basic/redis/3-redis%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/">
        <h2 class="post-title">[redis] 执行流程</h2>
        
        <h3 class="post-subtitle">
            redis是单线程的，数据以键值对形式存储在内存
        </h3>
        
        
        
    </a>

    <p class="post-meta">
        <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 27, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;156&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ch
    
  
  
</span>


    </p>
    <div class="post-entry">
        
        <h2 id="四执行流程">四、执行流程</h2>
<ol>
<li>内存结构</li>
<li>核心执行是单线程</li>
<li>多线程负载一些异步任务</li>
</ol>
<h3 id="1redis在内存中是怎么存储的">1.Redis在内存中是怎么存储的</h3>
<p>redis是内存存储，将数据放在redis时，都是以键值对形式存到内存</p>
<h4 id="数据库结构">数据库结构</h4>
<p>redisDb代表Redis数据库结构，各种操作对象，都是存储在dict数据结构里</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="c1">// redisDb 结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">type</span> <span class="k">struct</span> <span class="n">redisDb</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span>           <span class="c1">//字典
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dict</span> <span class="o">*</span><span class="n">expires</span><span class="p">;</span>        <span class="c1">// 过期键
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dict</span> <span class="o">*</span><span class="n">blocking_keys</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dict</span> <span class="o">*</span><span class="n">ready_keys</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dict</span> <span class="o">*</span><span class="n">watched_keys</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="kt">long</span> <span class="n">avg_ttl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">list</span> <span class="o">*</span><span class="n">defrag_later</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">redisDb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// dict 结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">dict</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dictType</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dictht</span> <span class="n">ht</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">rehashidx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iterators</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">dict</span><span class="p">;</span>
</span></span></code></pre></div><p>redisDb即数据库对象，指向了数据字典，字典包含我们平常存储的k-v数据，v支持任意redis对象</p>
<p><img src="https://rt5bap83jl.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjUwNmMwNDdlZTRiYmE0ODNjZjNlYWE1M2U2ZjRhZmZfMVhzNEFiWk0xQ2tYMXh0T21yQ045OGgwOVVLSzhDV0NfVG9rZW46VkdtbmJwMEZSb0tqcHF4ckhqVGNrTHI4blBkXzE3MjE4NDE0MjU6MTcyMTg0NTAyNV9WNA" alt=""></p>
<p>在增加、查询、更新、删除的操作后，分别在内存存储是怎么体现的？</p>
<h4 id="增删改查在redis内存中的体现">增删改查在Redis内存中的体现</h4>
<ul>
<li>添加数据</li>
</ul>
<p>即添加键值对，添加到dict结构字典中，Key必须为String对象，value为任何类型的对象</p>
<p>添加数据后，会在redisDb里字段dict上添加dict对象</p>
<ul>
<li>查询数据</li>
</ul>
<p>直接在dict找到对应的key，即完成查询</p>
<ul>
<li>更新数据</li>
</ul>
<p>对已经Key对象的任何变更操作，都是更新</p>
<ul>
<li>删除数据</li>
</ul>
<p>删除即把key和value从dict结构里删除</p>
<h4 id="过期键">过期键</h4>
<p>Redis可以设置过期键，到达一定时间，这些对象会被自动过期并回收</p>
<p>**过期键存储在<strong><strong>expires</strong></strong>字典上，**expires字典中，value就是过期时间</p>
<p>在redisDb中，dict和expires中Key对象，实际都是存储String对象指针，两个的key都会指向内存相应的字符串地址</p>
<h3 id="2redis是单线程还是多线程">2.Redis是单线程？还是多线程？</h3>
<p>redis是一个能高效处理请求的组件</p>
<p>核心处理逻辑，Redis一直都是单线程，其他辅助模块会有一些多线程、多进程的功能，例如：复制模块用的多进程；某些异步流程从4.0开始用多线程；网络I/O解包从6.0开始用多线程；</p>
<blockquote>
<p>核心处理逻辑：Redis在处理客户端的请求时，包括获取（socket写）、解析、执行、内容返回等都是由一个顺序串行的主线程处理，这就是所谓的单线程</p>
</blockquote>
<h4 id="redis为什么选择单线程">Redis为什么选择单线程</h4>
<p>redis的定位是内存k-v存储，是做短平快的热点数据处理，一般来说执行会很快，执行本身不会成为瓶颈，瓶颈通常在网络I/O，处理逻辑多线程并不会有太大收益</p>
<p>同时Redis本身秉持简洁高效的理念，代码的简单性、可维护性是redis一直依赖的追求，执行本身不应该成为瓶颈，而且多线程本身也会引起额外成本</p>
<h4 id="1多线程引入的复杂度是极大的">1.多线程引入的复杂度是极大的</h4>
<ol>
<li>
<p>多线程引入后，redis原来的顺序执行特性就不复存在，为了事务的原子性、隔离性，redis就不得不引入一些很复杂的实现</p>
</li>
<li>
<p>redis的数据结构是极其高效，在单线程模式下做了很多特性的优化，如果引入多线程，那么所有底层数据都要改为线性安全，这很复杂</p>
</li>
<li>
<p>多线程模式使得程序调试更加复杂和麻烦，会带来额外的开发成本及运营成本</p>
</li>
</ol>
<h4 id="2多线程带来额外的成本">2.多线程带来额外的成本</h4>
<p>除了引入复杂度，多线程还会带来额外成本，包括</p>
<ol>
<li>
<p>上下文切换成本，多线程调度需要切换线程上下文，这个操作先存储当前线程的本地数据，程序指针，然后载入另一个线程数据，这种内核操作的成本不可忽略</p>
</li>
<li>
<p>同步机制的开销，一些公共资源，在单线程模式下直接访问就行，多线程需要通过加锁等方式进行同步</p>
</li>
<li>
<p>一个线程本身也占据内存大小，对redis这种内存数据库来说，内存非常珍贵，多线程本身带来的内存使用的成本也需要谨慎决策</p>
</li>
</ol>
<h4 id="总结">总结</h4>
<p>多线程会引入额外的复杂度和成本，而redis是追求简洁高效的存储组件，而且事实也证明，虽然redis是单线程处理架构，redis性能还是经受住了考验</p>
<h3 id="3redis单线程为什么能这么快">3.Redis单线程为什么能这么快</h3>
<h4 id="redis单线程">Redis单线程</h4>
<p>Redis核心的请求处理是单线程，但是Redis却能使用单线程模型达到每秒数万级别的处理能力，这是Redis多方面极致设计的一个综合结果</p>
        <a href="https://ahang7.github.io/post/basic/redis/3-redis%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/" class="post-read-more">[Read More]</a>
        
    </div>

    
    <div class="blog-tags">
        
       
       <a href="https://ahang7.github.io/tags/redis/">redis</a>&nbsp;
         
    </div>
    

</article>
          
            <article class="post-preview">
    <a href="https://ahang7.github.io/post/basic/redis/2-redis%E5%AF%B9%E8%B1%A1/">
        <h2 class="post-title">[redis] redis 对象</h2>
        
        <h3 class="post-subtitle">
            学习redis中的对象: string list hash set zset ...
        </h3>
        
        
        
    </a>

    <p class="post-meta">
        <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 26, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;779&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ch
    
  
  
</span>


    </p>
    <div class="post-entry">
        
        <h2 id="三对象">三、对象</h2>
<h3 id="redis-object-是什么">Redis Object 是什么？</h3>
<p>redis是key-value存储，key-value在redis中被抽象为对象(Object)，key只能是String对象，value支持丰富的对象类型{String, List, Set, Hash, Sorted Set, Stream&hellip;}</p>
<h4 id="object在内存中的样子">Object在内存中的样子</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="cp">#define LRU_BITS 24
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">reidsObject</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="nl">type</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="nl">encoding</span><span class="p">:</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="nl">lru</span><span class="p">:</span><span class="n">LRU_BITS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">refcount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">robj</span><span class="p">;</span>
</span></span></code></pre></div><ul>
<li>Type: 查看redis对象</li>
<li>Encoding: 表明使用哪种底层编码</li>
<li>Lru: 记录对象访问信息，用于内存淘汰</li>
<li>Refcount: 引用计数，用来描述有多少指针，指向该对象</li>
<li>Ptr: 内容指针，指向实际内容</li>
</ul>
<h4 id="对象与数据结果">对象与数据结果</h4>
<p>实际操作的对象有6个Redis对象，他们的底层依赖一些数据对象，包括字符串、跳表、哈希表、压缩列表、双端列表等</p>
<h3 id="1string">1.String</h3>
<h4 id="string是什么">String是什么</h4>
<p>String是字符串，是Redis中最基本的数据对象，最大为512MB，可以通过配置项<strong>proto-max-bulk-len</strong>修改它</p>
<p>String可以存储各种类型的字符串（包括二进制文件）</p>
<h4 id="适用场景">适用场景</h4>
<p>使用场景：一般用来存放<strong>字节数据</strong>、<strong>文本数据</strong>、<strong>序列化****后的对象数据</strong></p>
<p>例子：</p>
<ol>
<li>缓存场景：Value存Json字符串等信息</li>
<li>计数场景：因为Redis处理命令是单线程，所以执行命令的过程是原子的，因此String数据类型适合计数场景</li>
</ol>
<h4 id="在redis中怎么使用">在redis中怎么使用：</h4>
<p>常用操作：创建、查询、更新、删除</p>
<ul>
<li>
<p>创建 &ndash;&gt; set, setnx</p>
<ul>
<li><strong>SET</strong> key value # 设置一个key值为特定的value
  set命令扩展参数：EX（键过期时间秒）、PX（键过期时间毫秒）、NX（只有键不存在时才对键进行操作，基本替代下面的SETNX操作）、XX（键存在时才对键进行操作）</li>
<li><strong>SETNX</strong> key value # 用于在指定的<strong>key不存在</strong>时，为key设置指定的值</li>
</ul>
</li>
<li>
<p>查询 &ndash;&gt; get, mget</p>
<ul>
<li>
<p><strong>Get</strong> key # 查询某个key，存在就返回对应的value，不存在返回nil</p>
        <a href="https://ahang7.github.io/post/basic/redis/2-redis%E5%AF%B9%E8%B1%A1/" class="post-read-more">[Read More]</a>
        
    </div>

    
    <div class="blog-tags">
        
       
       <a href="https://ahang7.github.io/tags/redis/">redis</a>&nbsp;
         
    </div>
    

</article>
          
            <article class="post-preview">
    <a href="https://ahang7.github.io/post/basic/redis/1-redis-base%E7%90%86%E8%AE%BA/">
        <h2 class="post-title">[redis] Base理论</h2>
        
        <h3 class="post-subtitle">
            理解BASE理论，是CAP中一致性的妥协
        </h3>
        
        
        
    </a>

    <p class="post-meta">
        <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on October 25, 2024
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;1&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;26&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;ch
    
  
  
</span>


    </p>
    <div class="post-entry">
        
        <h2 id="一什么是redis">一、什么是redis？</h2>
<ul>
<li>redis是一个内存数据结构储存，KV储存</li>
<li>常用于缓存、消息中转、数据流引擎、分布式锁</li>
<li>支持的数据结构有：字符串、散列、列表、集合、带范围查询的排序集合、位图、超日志、地理空间索引和流</li>
</ul>
<p>(strings, hashes, lists, sets, sorted sets with range queries, bitmaps, hyperloglogs, geospatial indexes, and streams)</p>
<ul>
<li>redis内置了复制、Lua脚本、LRU驱逐、事务和不同级别的磁盘持久化</li>
</ul>
<blockquote>
<p><a href="https://try.redis.io/">Try Redis</a> 官方redis在线操作平台</p>
</blockquote>
<h2 id="二base理论">二、Base理论</h2>
<p>Base理论是CAP中一致性的妥协，不追求强一致性，允许数据在一段时间内不一致，但是最终达到一致状态</p>
<blockquote>
<p><a href="https://rt5bap83jl.feishu.cn/docx/XXiHdxRVRokY7vxCqVccZ9PlnVe">分布式系统的CAP定理与BASE理论</a></p>
</blockquote>

        
    </div>

    
    <div class="blog-tags">
        
       
       <a href="https://ahang7.github.io/tags/redis/">redis</a>&nbsp;
         
    </div>
    

</article>
          
        </div>
        
      </div>
    </div>
  </div>

      <footer>
  <div class="container">
    
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
		
		  <a href="mailto:ch1447571882@qq.com" title="Email me">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://github.com/ahang7" title="GitHub">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
		
		  <a href="https://gitlab.com/username" title="GitLab">
		
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-gitlab fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
          <li>
            <a href="/tags/redis/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="yourwebsite.com">ch</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2024
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://ahang7.github.io/">Beautiful Hugo</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.136.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js" integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

<script src="https://ahang7.github.io/js/main.js"></script>
<script src="https://ahang7.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://ahang7.github.io/js/load-photoswipe.js"></script>










    
  </body>
</html>

